version: "3.8"

services:
  # ğŸ› ï¸ 0. Init Service (íŒŒì¼ ìƒì„± ì „ë‹´)
  # ì´ ë…€ì„ì´ ë¨¼ì € ì‹¤í–‰ë˜ì–´ mlflow.db íŒŒì¼ì„ í™•ì‹¤í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
  init:
    image: alpine:latest
    container_name: gemma-init
    # data í´ë”ê°€ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , db íŒŒì¼ì´ ì—†ìœ¼ë©´ ë§Œë“¤ê³ , ê¶Œí•œì„ 777ë¡œ ì—½ë‹ˆë‹¤.
    command: >
      sh -c "mkdir -p /data/artifacts && 
             touch /data/mlflow.db && 
             chmod 777 /data/mlflow.db /data/artifacts"
    volumes:
      - ./data:/data

  # ğŸš€ 1. Main Service
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: gemma-mlflow
    ports:
      - "5001:5000"
    environment:
      MLFLOW_ARTIFACT_ROOT: /mlartifacts
    command: >
      mlflow server 
      --backend-store-uri sqlite:///mlflow.db
      --default-artifact-root /mlartifacts 
      --serve-artifacts 
      --host 0.0.0.0
    volumes:
      - ./data/mlflow.db:/mlflow.db
      - ./data/artifacts:/mlartifacts
    # âœ… í•µì‹¬: init ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ëë‚˜ì•¼(service_completed_successfully) ì‹¤í–‰ë¨
    depends_on:
      init:
        condition: service_completed_successfully
